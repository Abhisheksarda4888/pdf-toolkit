<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PDF Toolkit Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --p:#7c3aed;--p2:#a855f7;--p3:#c084fc;
  --acc:#06b6d4;--acc2:#22d3ee;
  --ok:#10b981;--warn:#f59e0b;--err:#ef4444;
  --bg:#070711;--bg2:#0d0d1f;--bg3:#12122a;
  --card:#161630;--card2:#1e1e3f;--card3:#252550;
  --border:#2a2a55;--border2:#3a3a6a;
  --txt:#e2e8f0;--txt2:#94a3b8;--txt3:#64748b;
  --glow:rgba(124,58,237,.35);
}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}

/* BG ANIMATION */
body::before{content:'';position:fixed;inset:0;background:
  radial-gradient(ellipse 80% 50% at 20% -20%,rgba(124,58,237,.15),transparent),
  radial-gradient(ellipse 60% 40% at 80% 100%,rgba(6,182,212,.1),transparent);
  pointer-events:none;z-index:0}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:10px}

/* ===== HEADER ===== */
header{position:sticky;top:0;z-index:200;background:rgba(7,7,17,.85);backdrop-filter:blur(20px);border-bottom:1px solid rgba(124,58,237,.2);padding:0 24px}
.hdr-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;gap:16px;height:64px}
.logo-wrap{display:flex;align-items:center;gap:10px;text-decoration:none}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--p),var(--acc));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;box-shadow:0 0 20px var(--glow)}
.logo-text{font-size:1.25rem;font-weight:800;background:linear-gradient(135deg,#fff,var(--p3));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-badge{background:linear-gradient(135deg,var(--p),var(--acc));color:#fff;font-size:.55rem;font-weight:700;padding:2px 7px;border-radius:20px;margin-left:6px;letter-spacing:.05em}
.hdr-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.hdr-pill{background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.25);color:#10b981;font-size:.72rem;font-weight:600;padding:5px 12px;border-radius:20px;display:flex;align-items:center;gap:5px}
.hdr-pill::before{content:'';width:6px;height:6px;border-radius:50%;background:#10b981;animation:pulse2 2s infinite}
@keyframes pulse2{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(16,185,129,.4)}50%{opacity:.7;box-shadow:0 0 0 4px rgba(16,185,129,0)}}

/* ===== HERO ===== */
.hero{text-align:center;padding:60px 24px 48px;position:relative;z-index:1}
.hero-tag{display:inline-flex;align-items:center;gap:6px;background:rgba(124,58,237,.12);border:1px solid rgba(124,58,237,.3);color:var(--p3);font-size:.75rem;font-weight:600;padding:6px 16px;border-radius:20px;margin-bottom:20px;letter-spacing:.05em}
.hero h1{font-size:clamp(2rem,5vw,3.5rem);font-weight:900;line-height:1.1;margin-bottom:16px}
.hero h1 span{background:linear-gradient(135deg,var(--p3),var(--acc2),#fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero p{color:var(--txt2);font-size:1.05rem;max-width:560px;margin:0 auto 32px}
.search-wrap{max-width:520px;margin:0 auto;position:relative}
.search-wrap input{width:100%;padding:14px 56px 14px 50px;background:var(--card);border:1px solid var(--border);border-radius:50px;color:var(--txt);font-size:.95rem;outline:none;transition:.3s;font-family:inherit}
.search-wrap input:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(124,58,237,.15),0 0 30px rgba(124,58,237,.1)}
.search-wrap input::placeholder{color:var(--txt3)}
.search-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);color:var(--txt3);font-size:1rem}
.search-clear{position:absolute;right:18px;top:50%;transform:translateY(-50%);color:var(--txt3);cursor:pointer;display:none;font-size:.9rem;background:none;border:none;padding:4px}

/* STATS BAR */
.stats-bar{display:flex;justify-content:center;gap:32px;margin-top:32px;flex-wrap:wrap}
.stat{text-align:center}
.stat-num{font-size:1.6rem;font-weight:800;background:linear-gradient(135deg,var(--p3),var(--acc2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-lbl{font-size:.72rem;color:var(--txt3);text-transform:uppercase;letter-spacing:.1em;margin-top:2px}

/* ===== TOOLS GRID ===== */
#home{position:relative;z-index:1}
.tools-section{max-width:1400px;margin:0 auto;padding:0 24px 40px}
.cat-header{display:flex;align-items:center;gap:12px;margin:36px 0 16px}
.cat-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.cat-name{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.15em;color:var(--txt2)}
.cat-line{flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}
.tools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:12px}
.tool-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px 14px;cursor:pointer;transition:all .25s;text-align:center;position:relative;overflow:hidden;group:true}
.tool-card::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(124,58,237,.06),rgba(6,182,212,.04));opacity:0;transition:.25s}
.tool-card:hover{border-color:var(--p);transform:translateY(-4px);box-shadow:0 12px 32px rgba(124,58,237,.2),0 0 0 1px rgba(124,58,237,.1)}
.tool-card:hover::after{opacity:1}
.tool-card:active{transform:translateY(-2px)}
.tc-icon{font-size:2.2rem;margin-bottom:10px;display:block;position:relative;z-index:1}
.tc-name{font-size:.88rem;font-weight:700;color:var(--txt);margin-bottom:4px;position:relative;z-index:1}
.tc-desc{font-size:.72rem;color:var(--txt2);line-height:1.4;position:relative;z-index:1}
.tc-badge{position:absolute;top:10px;right:10px;font-size:.58rem;font-weight:700;padding:2px 8px;border-radius:20px;letter-spacing:.05em;text-transform:uppercase}
.badge-hot{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.2)}
.badge-new{background:rgba(16,185,129,.15);color:#10b981;border:1px solid rgba(16,185,129,.2)}
.badge-pop{background:rgba(124,58,237,.15);color:var(--p3);border:1px solid rgba(124,58,237,.2)}

/* ===== TOOL PAGE ===== */
#toolPage{display:none;position:relative;z-index:1;min-height:calc(100vh - 64px)}
.tool-pg-inner{max-width:900px;margin:0 auto;padding:32px 24px}
.back-btn{display:inline-flex;align-items:center;gap:8px;color:var(--txt2);cursor:pointer;font-size:.88rem;margin-bottom:28px;transition:.2s;border:none;background:rgba(255,255,255,.04);padding:8px 16px;border-radius:50px;border:1px solid var(--border)}
.back-btn:hover{color:var(--txt);border-color:var(--p);background:rgba(124,58,237,.08)}
.tool-hdr{display:flex;align-items:flex-start;gap:16px;margin-bottom:28px;padding:24px;background:var(--card);border:1px solid var(--border);border-radius:20px}
.tool-hdr-icon{width:56px;height:56px;background:linear-gradient(135deg,rgba(124,58,237,.2),rgba(6,182,212,.15));border:1px solid rgba(124,58,237,.2);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0}
.tool-hdr h2{font-size:1.5rem;font-weight:800;margin-bottom:4px}
.tool-hdr p{color:var(--txt2);font-size:.88rem;line-height:1.5}

/* DROP ZONE */
.drop-zone{border:2px dashed var(--border);border-radius:18px;padding:44px 24px;text-align:center;cursor:pointer;transition:all .3s;background:linear-gradient(135deg,rgba(13,13,31,.8),rgba(18,18,42,.6));margin-bottom:16px;position:relative;overflow:hidden}
.drop-zone::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(124,58,237,.03),rgba(6,182,212,.02));opacity:0;transition:.3s}
.drop-zone:hover,.drop-zone.drag{border-color:var(--p);background:linear-gradient(135deg,rgba(124,58,237,.06),rgba(6,182,212,.04))}
.drop-zone:hover::before,.drop-zone.drag::before{opacity:1}
.dz-circle{width:72px;height:72px;background:linear-gradient(135deg,rgba(124,58,237,.15),rgba(6,182,212,.1));border:1px solid rgba(124,58,237,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin:0 auto 14px}
.drop-zone h3{font-size:1rem;font-weight:700;margin-bottom:6px;position:relative;z-index:1}
.drop-zone p{color:var(--txt2);font-size:.8rem;position:relative;z-index:1}
.dz-types{display:flex;justify-content:center;gap:6px;margin-top:10px;flex-wrap:wrap}
.dz-type{background:rgba(124,58,237,.1);border:1px solid rgba(124,58,237,.2);color:var(--p3);font-size:.65rem;font-weight:700;padding:2px 8px;border-radius:6px;letter-spacing:.05em}
.drop-zone input{display:none}

/* FILES LIST */
.files-list{margin-bottom:16px}
.file-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px;margin-bottom:8px;transition:.2s}
.file-item:hover{border-color:var(--border2)}
.fi-icon-wrap{width:38px;height:38px;background:linear-gradient(135deg,rgba(124,58,237,.15),rgba(6,182,212,.1));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
.fi-info{flex:1;min-width:0}
.fi-name{font-size:.88rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fi-size{font-size:.72rem;color:var(--txt3);margin-top:1px}
.fi-remove{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.15);color:#ef4444;cursor:pointer;font-size:.8rem;padding:6px 10px;border-radius:8px;transition:.2s;flex-shrink:0}
.fi-remove:hover{background:rgba(239,68,68,.15)}

/* CONTROLS */
.ctrl-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
.ctrl-card h4{font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--txt2);margin-bottom:14px;display:flex;align-items:center;gap:6px}
.ctrl-row{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.ctrl-row:last-child{margin-bottom:0}
.ctrl-row label{font-size:.82rem;color:var(--txt2);min-width:130px;font-weight:500}
.inp{background:var(--card2);border:1px solid var(--border);color:var(--txt);padding:9px 13px;border-radius:10px;font-size:.85rem;outline:none;transition:.2s;font-family:inherit}
.inp:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(124,58,237,.1)}
select.inp option{background:var(--card2);color:var(--txt)}

/* BUTTONS */
.btn{padding:11px 26px;border-radius:12px;border:none;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px;font-family:inherit;letter-spacing:.01em}
.btn-primary{background:linear-gradient(135deg,var(--p),#6d28d9);color:#fff;box-shadow:0 4px 20px rgba(124,58,237,.35)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(124,58,237,.5)}
.btn-primary:active{transform:translateY(0)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-ghost{background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--txt2)}
.btn-ghost:hover{border-color:var(--p);color:var(--p3);background:rgba(124,58,237,.08)}
.btn-success{background:linear-gradient(135deg,#059669,#047857);color:#fff;box-shadow:0 4px 16px rgba(5,150,105,.3)}
.btn-sm{padding:7px 16px;font-size:.8rem;border-radius:8px}
.btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px}

/* PROGRESS */
.prog-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 20px;margin:14px 0;display:none}
.prog-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.prog-label{font-size:.85rem;font-weight:600}
.prog-pct{font-size:.85rem;color:var(--p3);font-weight:700}
.prog-track{height:8px;background:var(--card2);border-radius:20px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--p),var(--acc));border-radius:20px;transition:width .35s cubic-bezier(.4,0,.2,1);width:0;position:relative}
.prog-fill::after{content:'';position:absolute;top:0;right:0;width:20px;height:100%;background:rgba(255,255,255,.4);filter:blur(4px)}
.prog-msg{font-size:.78rem;color:var(--txt3);margin-top:6px}

/* RESULT */
.result-card{background:linear-gradient(135deg,rgba(16,185,129,.07),rgba(5,150,105,.04));border:1px solid rgba(16,185,129,.2);border-radius:16px;padding:20px 24px;margin-top:14px;display:none;text-align:center}
.result-card .res-icon{font-size:2.5rem;margin-bottom:8px}
.result-card h3{color:#10b981;font-size:1.1rem;margin-bottom:4px}
.result-card p{color:var(--txt2);font-size:.85rem;margin-bottom:14px}

/* INFO BOX */
.info-box{background:rgba(6,182,212,.06);border:1px solid rgba(6,182,212,.15);border-radius:12px;padding:11px 15px;font-size:.8rem;color:var(--txt2);margin-bottom:14px;line-height:1.5}
.info-box strong{color:var(--acc2)}

/* PAGES GRID */
.pages-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-bottom:16px;max-height:420px;overflow-y:auto;padding:4px}
.pg-thumb{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:8px;cursor:pointer;transition:.2s;text-align:center;position:relative}
.pg-thumb:hover{border-color:var(--border2)}
.pg-thumb.sel{border-color:var(--p);background:rgba(124,58,237,.08)}
.pg-thumb canvas{width:100%;height:auto;border-radius:6px;display:block}
.pg-num{font-size:.7rem;color:var(--txt3);margin-top:5px;font-weight:600}
.pg-check{position:absolute;top:5px;right:5px;width:18px;height:18px;border-radius:50%;background:var(--p);color:#fff;font-size:.6rem;display:none;align-items:center;justify-content:center;font-weight:700}
.pg-thumb.sel .pg-check{display:flex}

/* TEXT AREA */
.code-area{width:100%;background:var(--bg2);border:1px solid var(--border);color:var(--txt);padding:14px;border-radius:12px;font-size:.82rem;font-family:'Courier New',monospace;resize:vertical;outline:none;transition:.2s;line-height:1.6}
.code-area:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(124,58,237,.1)}

/* VIEWER */
#viewer-canvas-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:16px;overflow:auto;max-height:620px;display:flex;align-items:flex-start;justify-content:center;padding:20px}
#viewer-canvas{max-width:100%;border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,.6)}
.viewer-nav{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px}
.pg-counter{font-size:.9rem;font-weight:600;color:var(--txt2);flex:1;text-align:center}

/* COMPARE */
.compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
@media(max-width:600px){.compare-grid{grid-template-columns:1fr}}
.compare-pane h4{font-size:.85rem;font-weight:700;margin-bottom:10px;color:var(--txt2)}

/* SIMILARITY METER */
.sim-meter{height:12px;background:var(--card2);border-radius:20px;overflow:hidden;margin:8px 0}
.sim-fill{height:100%;border-radius:20px;transition:width 1s}

/* RESPONSIVE */
@media(max-width:640px){
  .tools-grid{grid-template-columns:repeat(auto-fill,minmax(145px,1fr))}
  .ctrl-row label{min-width:100px}
  .stats-bar{gap:20px}
}

/* ANIMATIONS */
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.tool-card{animation:fadeUp .3s ease both}
.tool-pg-inner{animation:fadeUp .25s ease}

/* NO RESULTS */
.no-results{text-align:center;padding:60px 24px;color:var(--txt3)}
.no-results .nr-icon{font-size:3rem;margin-bottom:12px}

/* CATEGORY COLORS */
.dot-organize{background:#7c3aed}.dot-edit{background:#06b6d4}.dot-security{background:#f59e0b}
.dot-convert{background:#10b981}.dot-utility{background:#ef4444}.dot-create{background:#8b5cf6}
</style>
</head>
<body>

<header>
  <div class="hdr-inner">
    <a class="logo-wrap" href="#" onclick="goHome();return false">
      <div class="logo-icon">üìÑ</div>
      <span class="logo-text">PDF Toolkit<span class="logo-badge">PRO</span></span>
    </a>
    <div class="hdr-right">
      <div class="hdr-pill">üîí 100% Offline ‚Äî Files Never Leave Your Device</div>
    </div>
  </div>
</header>

<!-- HOME -->
<div id="home">
  <div class="hero">
    <div class="hero-tag">‚ú¶ 25+ Professional PDF Tools</div>
    <h1>The <span>All-in-One</span><br>PDF Toolkit</h1>
    <p>Merge, split, compress, convert & edit PDFs entirely in your browser. No uploads. No servers. No limits.</p>
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" placeholder="Search 25+ tools‚Ä¶" oninput="filterTools(this.value)" autocomplete="off">
      <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
    </div>
    <div class="stats-bar">
      <div class="stat"><div class="stat-num">25+</div><div class="stat-lbl">Tools</div></div>
      <div class="stat"><div class="stat-num">0</div><div class="stat-lbl">Uploads</div></div>
      <div class="stat"><div class="stat-num">100%</div><div class="stat-lbl">Private</div></div>
      <div class="stat"><div class="stat-num">Free</div><div class="stat-lbl">Forever</div></div>
    </div>
  </div>
  <div class="tools-section" id="toolsContainer"></div>
</div>

<!-- TOOL PAGE -->
<div id="toolPage">
  <div class="tool-pg-inner">
    <button class="back-btn" onclick="goHome()">‚Üê Back to all tools</button>
    <div id="toolContent"></div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
const {PDFDocument,rgb,StandardFonts,degrees}=PDFLib;

const CATS=[
  {id:'organize',name:'Organize',color:'dot-organize'},
  {id:'edit',name:'Edit & Annotate',color:'dot-edit'},
  {id:'security',name:'Security',color:'dot-security'},
  {id:'convert',name:'Convert',color:'dot-convert'},
  {id:'utility',name:'Utility',color:'dot-utility'},
  {id:'create',name:'Create',color:'dot-create'},
];

const TOOLS=[
  {id:'merge',icon:'üîó',name:'Merge PDF',desc:'Combine multiple PDFs into one',cat:'organize',badge:'pop'},
  {id:'split',icon:'‚úÇÔ∏è',name:'Split PDF',desc:'Split into separate files or ranges',cat:'organize'},
  {id:'removepages',icon:'üóëÔ∏è',name:'Remove Pages',desc:'Delete specific pages visually',cat:'organize'},
  {id:'reorder',icon:'‚ÜïÔ∏è',name:'Reorder Pages',desc:'Drag-drop page rearrangement',cat:'organize'},
  {id:'rotate',icon:'üîÑ',name:'Rotate Pages',desc:'Rotate pages 90¬∞/180¬∞/270¬∞',cat:'organize'},
  {id:'reverse',icon:'üîÅ',name:'Reverse Pages',desc:'Flip the entire page order',cat:'organize'},
  {id:'pagenumber',icon:'üî¢',name:'Add Page Numbers',desc:'Customizable numbering & position',cat:'edit'},
  {id:'watermark',icon:'üíß',name:'Watermark PDF',desc:'Text watermarks in any style',cat:'edit'},
  {id:'crop',icon:'‚¨õ',name:'Crop PDF',desc:'Trim page margins precisely',cat:'edit'},
  {id:'flatten',icon:'üìã',name:'Flatten PDF',desc:'Flatten forms & annotations',cat:'edit'},
  {id:'metadata',icon:'üè∑Ô∏è',name:'Edit Metadata',desc:'Change title, author, keywords',cat:'edit'},
  {id:'extracttext',icon:'üìÑ',name:'Extract Text',desc:'Extract text from specific pages',cat:'edit'},
  {id:'protect',icon:'üîê',name:'Protect PDF',desc:'Add password protection',cat:'security',badge:'hot'},
  {id:'unlock',icon:'üîì',name:'Unlock PDF',desc:'Remove PDF password',cat:'security'},
  {id:'compress',icon:'üóúÔ∏è',name:'Compress PDF',desc:'Reduce file size efficiently',cat:'convert',badge:'pop'},
  {id:'grayscale',icon:'‚¨õ',name:'Grayscale PDF',desc:'Convert to black & white',cat:'convert'},
  {id:'pdf2img',icon:'üñºÔ∏è',name:'PDF ‚Üí Images',desc:'Export pages as JPG/PNG',cat:'convert'},
  {id:'img2pdf',icon:'üì∑',name:'Images ‚Üí PDF',desc:'Combine images into PDF',cat:'convert'},
  {id:'pdf2text',icon:'üìù',name:'PDF ‚Üí Text',desc:'Extract all text content',cat:'convert'},
  {id:'extractimages',icon:'üé®',name:'Extract Images',desc:'Save all page images',cat:'convert'},
  {id:'html2pdf',icon:'üåê',name:'HTML ‚Üí PDF',desc:'Convert HTML to PDF',cat:'convert'},
  {id:'viewer',icon:'üëÅÔ∏è',name:'PDF Viewer',desc:'Full-featured in-browser viewer',cat:'utility',badge:'new'},
  {id:'compare',icon:'üîç',name:'Compare PDFs',desc:'Find text differences',cat:'utility'},
  {id:'repair',icon:'üîß',name:'Repair PDF',desc:'Fix corrupted PDF files',cat:'utility'},
  {id:'blank',icon:'‚ûï',name:'Create Blank PDF',desc:'New PDF with custom settings',cat:'create'},
];

const BADGE_HTML={
  hot:`<span class="tc-badge badge-hot">üî• Hot</span>`,
  new:`<span class="tc-badge badge-new">‚ú® New</span>`,
  pop:`<span class="tc-badge badge-pop">‚≠ê Popular</span>`,
};

function toolCardHTML(t){
  return `<div class="tool-card" onclick="openTool('${t.id}')" style="animation-delay:${Math.random()*.15}s">
    ${t.badge?BADGE_HTML[t.badge]:''}
    <span class="tc-icon">${t.icon}</span>
    <div class="tc-name">${t.name}</div>
    <div class="tc-desc">${t.desc}</div>
  </div>`;
}

function renderHome(filter=''){
  const c=document.getElementById('toolsContainer');
  let html='',total=0;
  CATS.forEach(cat=>{
    const tools=TOOLS.filter(t=>t.cat===cat.id&&(!filter||t.name.toLowerCase().includes(filter)||t.desc.toLowerCase().includes(filter)||t.id.includes(filter)));
    if(!tools.length)return;
    total+=tools.length;
    html+=`<div class="cat-header"><div class="cat-dot ${cat.color}"></div><div class="cat-name">${cat.name}</div><div class="cat-line"></div></div><div class="tools-grid">${tools.map(toolCardHTML).join('')}</div>`;
  });
  if(!total)html=`<div class="no-results"><div class="nr-icon">üîç</div><div>No tools found for "<strong>${filter}</strong>"</div></div>`;
  c.innerHTML=html;
}

function filterTools(v){
  document.getElementById('searchClear').style.display=v?'block':'none';
  renderHome(v.toLowerCase());
}
function clearSearch(){document.getElementById('searchInput').value='';filterTools('');document.getElementById('searchClear').style.display='none';}

function goHome(){
  document.getElementById('home').style.display='';
  document.getElementById('toolPage').style.display='none';
  window.scrollTo({top:0,behavior:'smooth'});
}

function openTool(id){
  document.getElementById('home').style.display='none';
  document.getElementById('toolPage').style.display='';
  const t=TOOLS.find(x=>x.id===id);
  document.getElementById('toolContent').innerHTML=`
    <div class="tool-hdr">
      <div class="tool-hdr-icon">${t.icon}</div>
      <div><h2>${t.name}</h2><p>${t.desc}</p></div>
    </div>
    <div id="toolBody"></div>`;
  window.scrollTo({top:0,behavior:'smooth'});
  STATE={};
  RENDERERS[id]&&RENDERERS[id]();
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let STATE={};
function fmtSz(b){return b<1024?b+'B':b<1048576?(b/1024).toFixed(1)+'KB':(b/1048576).toFixed(2)+'MB'}

function dz(id,multi=false,accept='.pdf',label=''){
  return `<div class="drop-zone" id="dz-${id}" onclick="document.getElementById('fi-${id}').click()"
    ondragover="event.preventDefault();this.classList.add('drag')"
    ondragleave="this.classList.remove('drag')"
    ondrop="dropH(event,'${id}')">
    <div class="dz-circle">üìÇ</div>
    <h3>${label||'Drop your PDF here or click to browse'}</h3>
    <p>${multi?'Multiple files supported':'Single file'}</p>
    <div class="dz-types">${accept.split(',').map(a=>`<span class="dz-type">${a.replace('.','').toUpperCase()}</span>`).join('')}</div>
    <input type="file" id="fi-${id}" accept="${accept}" ${multi?'multiple':''} onchange="fileH(event,'${id}')">
  </div>`;
}
function dropH(e,id){e.preventDefault();document.getElementById('dz-'+id).classList.remove('drag');pFiles(id,[...e.dataTransfer.files]);}
function fileH(e,id){pFiles(id,[...e.target.files]);}
function pFiles(id,files){if(!STATE[id])STATE[id]={};STATE[id].files=files;renderFL(id,files);}
function renderFL(id,files){
  const el=document.getElementById('fl-'+id);if(!el)return;
  el.innerHTML=files.map((f,i)=>`<div class="file-item">
    <div class="fi-icon-wrap">üìÑ</div>
    <div class="fi-info"><div class="fi-name">${f.name}</div><div class="fi-size">${fmtSz(f.size)}</div></div>
    <button class="fi-remove" onclick="rmFile('${id}',${i})">‚úï Remove</button>
  </div>`).join('');
}
function rmFile(id,i){STATE[id].files.splice(i,1);renderFL(id,STATE[id].files);}

function progHTML(id){return `<div class="prog-wrap" id="pw-${id}"><div class="prog-top"><span class="prog-label" id="pl-${id}">Processing‚Ä¶</span><span class="prog-pct" id="pp-${id}">0%</span></div><div class="prog-track"><div class="prog-fill" id="pf-${id}"></div></div><div class="prog-msg" id="pm-${id}"></div></div>`;}
function showProg(id,pct,lbl='',msg=''){
  const pw=document.getElementById('pw-'+id);if(pw)pw.style.display='';
  const pf=document.getElementById('pf-'+id);if(pf)pf.style.width=pct+'%';
  const pp=document.getElementById('pp-'+id);if(pp)pp.textContent=pct+'%';
  const pl=document.getElementById('pl-'+id);if(pl&&lbl)pl.textContent=lbl;
  const pm=document.getElementById('pm-'+id);if(pm&&msg)pm.textContent=msg;
}
function resHTML(id){return `<div class="result-card" id="rb-${id}"><div class="res-icon">‚úÖ</div><h3>Done!</h3><p id="rb-msg-${id}"></p><div id="rb-btn-${id}"></div></div>`;}
function showRes(id,msg,btns=''){
  const rb=document.getElementById('rb-'+id);if(rb)rb.style.display='';
  const rm=document.getElementById('rb-msg-'+id);if(rm)rm.textContent=msg;
  const rbt=document.getElementById('rb-btn-'+id);if(rbt)rbt.innerHTML=btns;
}
async function loadPDF(file){return await PDFDocument.load(await file.arrayBuffer(),{ignoreEncryption:true});}

// ‚îÄ‚îÄ‚îÄ RENDERERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RENDERERS={};

// MERGE
RENDERERS.merge=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('merge',true)}
    <div class="files-list" id="fl-merge"></div>
    <div class="btn-row">${progHTML('merge')}</div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doMerge()">üîó Merge PDFs</button></div>
    ${resHTML('merge')}`;
};
async function doMerge(){
  const files=STATE.merge?.files||[];
  if(files.length<2){alert('Please select at least 2 PDF files.');return;}
  showProg('merge',5,'Merging PDFs‚Ä¶');
  const merged=await PDFDocument.create();
  for(let i=0;i<files.length;i++){
    showProg('merge',5+Math.round((i/files.length)*90),`Merging ${i+1}/${files.length}‚Ä¶`);
    const d=await loadPDF(files[i]);
    const pgs=await merged.copyPages(d,d.getPageIndices());
    pgs.forEach(p=>merged.addPage(p));
  }
  showProg('merge',98,'Saving‚Ä¶');
  const b=await merged.save();
  saveAs(new Blob([b],{type:'application/pdf'}),'merged.pdf');
  showProg('merge',100,'Complete!');
  showRes('merge',`Merged ${files.length} files ‚Üí ${fmtSz(b.length)}`);
}

// SPLIT
RENDERERS.split=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('split')}
    <div class="files-list" id="fl-split"></div>
    <div class="ctrl-card">
      <h4>‚öôÔ∏è Split Settings</h4>
      <div class="ctrl-row"><label>Mode</label>
        <select class="inp" id="sm" onchange="toggleSplitOpts()">
          <option value="all">Every page (individual files)</option>
          <option value="range">Custom page ranges</option>
          <option value="every">Every N pages</option>
        </select>
      </div>
      <div id="split-extra"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doSplit()">‚úÇÔ∏è Split PDF</button></div>
    ${progHTML('split')}${resHTML('split')}`;
};
function toggleSplitOpts(){
  const m=document.getElementById('sm').value,el=document.getElementById('split-extra');
  el.innerHTML=m==='range'?`<div class="ctrl-row"><label>Page ranges</label><input class="inp" id="sr" placeholder="1-3, 5, 7-9" style="flex:1"></div>`:
    m==='every'?`<div class="ctrl-row"><label>Every N pages</label><input class="inp" id="sn" type="number" value="1" min="1" style="width:80px"></div>`:'';
}
async function doSplit(){
  const files=STATE.split?.files||[];
  if(!files.length){alert('Select a PDF.');return;}
  const doc=await loadPDF(files[0]);const total=doc.getPageCount();
  const mode=document.getElementById('sm').value;
  showProg('split',10,'Loading‚Ä¶');
  let ranges=[];
  if(mode==='all'){for(let i=0;i<total;i++)ranges.push([i,i]);}
  else if(mode==='every'){const n=parseInt(document.getElementById('sn').value)||1;for(let i=0;i<total;i+=n)ranges.push([i,Math.min(i+n-1,total-1)]);}
  else{document.getElementById('sr').value.split(',').forEach(s=>{s=s.trim();if(s.includes('-')){const[a,b]=s.split('-').map(x=>parseInt(x)-1);ranges.push([a,b]);}else ranges.push([parseInt(s)-1,parseInt(s)-1]);});}
  for(let i=0;i<ranges.length;i++){
    showProg('split',10+Math.round((i/ranges.length)*87),`Saving part ${i+1}/${ranges.length}‚Ä¶`);
    const nd=await PDFDocument.create();
    const[s,e]=ranges[i];
    const pgs=await nd.copyPages(doc,Array.from({length:e-s+1},(_,k)=>s+k));
    pgs.forEach(p=>nd.addPage(p));
    saveAs(new Blob([await nd.save()],{type:'application/pdf'}),`split_part${i+1}.pdf`);
  }
  showProg('split',100,'Done!');showRes('split',`Created ${ranges.length} file(s) from ${total} pages`);
}

// REMOVE PAGES
RENDERERS.removepages=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('removepages')}
    <div class="files-list" id="fl-removepages"></div>
    <div class="ctrl-card">
      <h4>üóëÔ∏è Page Selection</h4>
      <div class="ctrl-row"><label>Pages to remove</label><input class="inp" id="rmp" placeholder="e.g. 1, 3, 5-8" style="flex:1"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" onclick="loadRPThumbs()">üëÅ Preview Pages</button>
      <button class="btn btn-primary" onclick="doRemovePages()">üóëÔ∏è Remove & Save</button>
    </div>
    <div id="rp-thumbs" class="pages-grid" style="margin-top:14px"></div>
    ${progHTML('removepages')}${resHTML('removepages')}`;
};
async function loadRPThumbs(){
  const files=STATE.removepages?.files||[];if(!files.length){alert('Select a PDF.');return;}
  const pdf=await pdfjsLib.getDocument({data:await files[0].arrayBuffer()}).promise;
  const grid=document.getElementById('rp-thumbs');grid.innerHTML='';
  for(let i=1;i<=Math.min(pdf.numPages,24);i++){
    const pg=await pdf.getPage(i);const vp=pg.getViewport({scale:.38});
    const c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;
    await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
    const div=document.createElement('div');div.className='pg-thumb';
    div.innerHTML=`<div class="pg-check">‚úì</div><div class="pg-num">Page ${i}</div>`;
    div.insertBefore(c,div.firstChild);
    div.onclick=function(){
      this.classList.toggle('sel');
      document.getElementById('rmp').value=[...document.querySelectorAll('.pg-thumb.sel')].map(el=>el.querySelector('.pg-num').textContent.replace('Page ','')).join(',');
    };
    grid.appendChild(div);
  }
}
async function doRemovePages(){
  const files=STATE.removepages?.files||[];if(!files.length){alert('Select a PDF.');return;}
  const raw=document.getElementById('rmp').value;if(!raw.trim()){alert('Specify pages to remove.');return;}
  showProg('removepages',20,'Loading‚Ä¶');
  const doc=await loadPDF(files[0]);const toRm=new Set();
  raw.split(',').forEach(s=>{s=s.trim();if(s.includes('-')){const[a,b]=s.split('-').map(x=>parseInt(x)-1);for(let i=a;i<=b;i++)toRm.add(i);}else toRm.add(parseInt(s)-1);});
  const nd=await PDFDocument.create();
  const keep=doc.getPageIndices().filter(i=>!toRm.has(i));
  showProg('removepages',60,'Removing‚Ä¶');
  const pgs=await nd.copyPages(doc,keep);pgs.forEach(p=>nd.addPage(p));
  const b=await nd.save();
  showProg('removepages',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'pages_removed.pdf');
  showRes('removepages',`Removed ${toRm.size} page(s). ${keep.length} pages remain.`);
}

// REORDER
RENDERERS.reorder=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('reorder')}
    <div class="files-list" id="fl-reorder"></div>
    <div class="btn-row"><button class="btn btn-ghost" onclick="loadROThumbs()">üëÅ Load Page Previews</button></div>
    <div id="ro-thumbs" class="pages-grid" style="margin-top:14px"></div>
    <div class="ctrl-card" id="ro-ctrl" style="display:none">
      <h4>‚ÜïÔ∏è New Page Order</h4>
      <div class="ctrl-row"><label>Order (comma separated)</label><input class="inp" id="ro-ord" placeholder="3,1,2,4,5" style="flex:1"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doReorder()">‚ÜïÔ∏è Reorder & Save</button></div>
    ${progHTML('reorder')}${resHTML('reorder')}`;
};
async function loadROThumbs(){
  const files=STATE.reorder?.files||[];if(!files.length){alert('Select a PDF.');return;}
  const pdf=await pdfjsLib.getDocument({data:await files[0].arrayBuffer()}).promise;
  const grid=document.getElementById('ro-thumbs');grid.innerHTML='';
  document.getElementById('ro-ctrl').style.display='';
  const nums=[];
  for(let i=1;i<=Math.min(pdf.numPages,30);i++){
    const pg=await pdf.getPage(i);const vp=pg.getViewport({scale:.32});
    const c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;
    await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
    const div=document.createElement('div');div.className='pg-thumb';
    div.innerHTML=`<div class="pg-num">Page ${i}</div>`;div.insertBefore(c,div.firstChild);
    grid.appendChild(div);nums.push(i);
  }
  document.getElementById('ro-ord').value=nums.join(',');
}
async function doReorder(){
  const files=STATE.reorder?.files||[];if(!files.length){alert('Select a PDF.');return;}
  const raw=document.getElementById('ro-ord').value;if(!raw.trim()){alert('Enter page order.');return;}
  showProg('reorder',20,'Loading‚Ä¶');
  const doc=await loadPDF(files[0]);
  const order=raw.split(',').map(x=>parseInt(x.trim())-1);
  const nd=await PDFDocument.create();
  showProg('reorder',60,'Reordering‚Ä¶');
  const pgs=await nd.copyPages(doc,order);pgs.forEach(p=>nd.addPage(p));
  const b=await nd.save();
  showProg('reorder',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'reordered.pdf');
  showRes('reorder',`Reordered ${order.length} pages`);
}

// ROTATE
RENDERERS.rotate=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('rotate')}
    <div class="files-list" id="fl-rotate"></div>
    <div class="ctrl-card">
      <h4>üîÑ Rotation Settings</h4>
      <div class="ctrl-row"><label>Pages</label><input class="inp" id="rt-pgs" placeholder="all  or  1,3,5-8" style="flex:1"></div>
      <div class="ctrl-row"><label>Direction</label>
        <select class="inp" id="rt-deg">
          <option value="90">90¬∞ Clockwise ‚Üª</option>
          <option value="270">90¬∞ Counter-clockwise ‚Ü∫</option>
          <option value="180">180¬∞ Flip ‚Üï</option>
        </select>
      </div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doRotate()">üîÑ Rotate</button></div>
    ${progHTML('rotate')}${resHTML('rotate')}`;
};
async function doRotate(){
  const files=STATE.rotate?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('rotate',20,'Loading‚Ä¶');
  const doc=await loadPDF(files[0]);const total=doc.getPageCount();
  const raw=document.getElementById('rt-pgs').value.trim();
  const deg=parseInt(document.getElementById('rt-deg').value);
  let idxs=[];
  if(!raw||raw==='all')idxs=doc.getPageIndices();
  else raw.split(',').forEach(s=>{s=s.trim();if(s.includes('-')){const[a,b]=s.split('-').map(x=>parseInt(x)-1);for(let i=a;i<=b;i++)idxs.push(i);}else idxs.push(parseInt(s)-1);});
  showProg('rotate',60,'Rotating‚Ä¶');
  idxs.forEach(i=>{const p=doc.getPage(i);p.setRotation(degrees((p.getRotation().angle+deg)%360));});
  const b=await doc.save();showProg('rotate',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'rotated.pdf');
  showRes('rotate',`Rotated ${idxs.length} page(s) by ${deg}¬∞`);
}

// REVERSE
RENDERERS.reverse=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('reverse')}
    <div class="files-list" id="fl-reverse"></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doReverse()">üîÅ Reverse Page Order</button></div>
    ${progHTML('reverse')}${resHTML('reverse')}`;
};
async function doReverse(){
  const files=STATE.reverse?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('reverse',30,'Loading‚Ä¶');
  const doc=await loadPDF(files[0]);
  const nd=await PDFDocument.create();
  const pgs=await nd.copyPages(doc,[...doc.getPageIndices()].reverse());
  pgs.forEach(p=>nd.addPage(p));
  const b=await nd.save();showProg('reverse',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'reversed.pdf');
  showRes('reverse',`Reversed ${doc.getPageCount()} pages`);
}

// PAGE NUMBERS
RENDERERS.pagenumber=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('pagenumber')}
    <div class="files-list" id="fl-pagenumber"></div>
    <div class="ctrl-card">
      <h4>üî¢ Numbering Settings</h4>
      <div class="ctrl-row"><label>Position</label>
        <select class="inp" id="pn-pos">
          <option value="bc">Bottom Center</option><option value="br">Bottom Right</option>
          <option value="bl">Bottom Left</option><option value="tc">Top Center</option>
          <option value="tr">Top Right</option><option value="tl">Top Left</option>
        </select>
      </div>
      <div class="ctrl-row"><label>Format</label>
        <select class="inp" id="pn-fmt">
          <option value="n">1, 2, 3 ‚Ä¶</option><option value="pn">Page 1</option>
          <option value="nof">1 of N</option><option value="pnof">Page 1 of N</option>
        </select>
      </div>
      <div class="ctrl-row"><label>Font size (pt)</label><input type="number" class="inp" id="pn-fs" value="12" min="6" max="36" style="width:80px"></div>
      <div class="ctrl-row"><label>Start numbering from</label><input type="number" class="inp" id="pn-start" value="1" min="1" style="width:80px"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doPN()">üî¢ Add Numbers</button></div>
    ${progHTML('pagenumber')}${resHTML('pagenumber')}`;
};
async function doPN(){
  const files=STATE.pagenumber?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('pagenumber',20,'Loading‚Ä¶');
  const doc=await loadPDF(files[0]);
  const font=await doc.embedFont(StandardFonts.Helvetica);
  const total=doc.getPageCount();
  const fmt=document.getElementById('pn-fmt').value;
  const pos=document.getElementById('pn-pos').value;
  const fs=parseInt(document.getElementById('pn-fs').value)||12;
  const start=parseInt(document.getElementById('pn-start').value)||1;
  for(let i=start-1;i<total;i++){
    const page=doc.getPage(i);const{width,height}=page.getSize();const num=i+1;
    let txt=fmt==='n'?`${num}`:fmt==='pn'?`Page ${num}`:fmt==='nof'?`${num} of ${total}`:`Page ${num} of ${total}`;
    const tw=font.widthOfTextAtSize(txt,fs);const m=20;
    let x,y;
    if(pos==='bc'){x=(width-tw)/2;y=m;}else if(pos==='br'){x=width-tw-m;y=m;}else if(pos==='bl'){x=m;y=m;}
    else if(pos==='tc'){x=(width-tw)/2;y=height-m-fs;}else if(pos==='tr'){x=width-tw-m;y=height-m-fs;}else{x=m;y=height-m-fs;}
    page.drawText(txt,{x,y,size:fs,font,color:rgb(0,0,0)});
  }
  showProg('pagenumber',90,'Saving‚Ä¶');
  const b=await doc.save();showProg('pagenumber',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'numbered.pdf');
  showRes('pagenumber',`Added page numbers to ${total-start+1} pages`);
}

// WATERMARK
RENDERERS.watermark=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('watermark')}
    <div class="files-list" id="fl-watermark"></div>
    <div class="ctrl-card">
      <h4>üíß Watermark Settings</h4>
      <div class="ctrl-row"><label>Text</label><input class="inp" id="wm-txt" value="CONFIDENTIAL" style="flex:1"></div>
      <div class="ctrl-row"><label>Style</label>
        <select class="inp" id="wm-sty">
          <option value="diagonal">Diagonal Center</option><option value="tile">Tiled</option>
          <option value="header">Header</option><option value="footer">Footer</option>
        </select>
      </div>
      <div class="ctrl-row"><label>Font size</label><input type="number" class="inp" id="wm-fs" value="48" min="12" max="120" style="width:80px"></div>
      <div class="ctrl-row"><label>Opacity (0.05‚Äì1)</label><input type="number" class="inp" id="wm-op" value="0.15" min="0.05" max="1" step="0.05" style="width:80px"></div>
      <div class="ctrl-row"><label>Color</label>
        <select class="inp" id="wm-col">
          <option value="gray">Gray</option><option value="red">Red</option>
          <option value="blue">Blue</option><option value="black">Black</option>
        </select>
      </div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doWM()">üíß Apply Watermark</button></div>
    ${progHTML('watermark')}${resHTML('watermark')}`;
};
async function doWM(){
  const files=STATE.watermark?.files||[];if(!files.length){alert('Select a PDF.');return;}
  const txt=document.getElementById('wm-txt').value||'WATERMARK';
  const sty=document.getElementById('wm-sty').value;
  const fs=parseInt(document.getElementById('wm-fs').value)||48;
  const op=parseFloat(document.getElementById('wm-op').value)||0.15;
  const col={gray:rgb(.5,.5,.5),red:rgb(.8,0,0),blue:rgb(0,0,.8),black:rgb(0,0,0)}[document.getElementById('wm-col').value];
  showProg('watermark',20,'Loading‚Ä¶');
  const doc=await loadPDF(files[0]);
  const font=await doc.embedFont(StandardFonts.HelveticaBold);
  for(let i=0;i<doc.getPageCount();i++){
    const pg=doc.getPage(i);const{width,height}=pg.getSize();
    const tw=font.widthOfTextAtSize(txt,fs);
    if(sty==='diagonal')pg.drawText(txt,{x:(width-tw)/2,y:height/2-fs/2,size:fs,font,color:col,opacity:op,rotate:degrees(45)});
    else if(sty==='tile'){for(let y=60;y<height;y+=120)for(let x=0;x<width;x+=180)pg.drawText(txt,{x,y,size:fs*.55,font,color:col,opacity:op,rotate:degrees(30)});}
    else if(sty==='header')pg.drawText(txt,{x:(width-tw)/2,y:height-38,size:fs*.55,font,color:col,opacity:op});
    else pg.drawText(txt,{x:(width-font.widthOfTextAtSize(txt,fs*.55))/2,y:18,size:fs*.55,font,color:col,opacity:op});
  }
  showProg('watermark',90,'Saving‚Ä¶');
  const b=await doc.save();showProg('watermark',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'watermarked.pdf');
  showRes('watermark',`Watermark applied to ${doc.getPageCount()} pages`);
}

// CROP
RENDERERS.crop=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('crop')}
    <div class="files-list" id="fl-crop"></div>
    <div class="ctrl-card">
      <h4>‚úÇÔ∏è Crop Margins (in points, 1pt = 1/72 inch)</h4>
      <div class="ctrl-row"><label>Left</label><input type="number" class="inp" id="cr-l" value="0" min="0" style="width:80px"> <label>Right</label><input type="number" class="inp" id="cr-r" value="0" min="0" style="width:80px"></div>
      <div class="ctrl-row"><label>Top</label><input type="number" class="inp" id="cr-t" value="0" min="0" style="width:80px"> <label>Bottom</label><input type="number" class="inp" id="cr-b" value="0" min="0" style="width:80px"></div>
      <div class="ctrl-row"><label>Apply to</label><input class="inp" id="cr-pgs" placeholder="all  or  1,3,5-8" style="flex:1"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doCrop()">‚úÇÔ∏è Crop PDF</button></div>
    ${progHTML('crop')}${resHTML('crop')}`;
};
async function doCrop(){
  const files=STATE.crop?.files||[];if(!files.length){alert('Select a PDF.');return;}
  const l=+document.getElementById('cr-l').value||0,r=+document.getElementById('cr-r').value||0,t=+document.getElementById('cr-t').value||0,b=+document.getElementById('cr-b').value||0;
  showProg('crop',30,'Loading‚Ä¶');
  const doc=await loadPDF(files[0]);
  const raw=document.getElementById('cr-pgs').value.trim();
  let idxs=!raw||raw==='all'?doc.getPageIndices():[];
  if(raw&&raw!=='all')raw.split(',').forEach(s=>{s=s.trim();if(s.includes('-')){const[a,b2]=s.split('-').map(x=>parseInt(x)-1);for(let i=a;i<=b2;i++)idxs.push(i);}else idxs.push(parseInt(s)-1);});
  idxs.forEach(i=>{const pg=doc.getPage(i);const{x,y,width,height}=pg.getCropBox();pg.setCropBox(x+l,y+b,width-l-r,height-t-b);});
  const bytes=await doc.save();showProg('crop',100,'Done!');
  saveAs(new Blob([bytes],{type:'application/pdf'}),'cropped.pdf');
  showRes('crop',`Cropped ${idxs.length} page(s)`);
}

// FLATTEN
RENDERERS.flatten=()=>{
  document.getElementById('toolBody').innerHTML=`
    <div class="info-box"><strong>‚ÑπÔ∏è Info:</strong> Flattening merges interactive form fields and annotations into static page content.</div>
    ${dz('flatten')}
    <div class="files-list" id="fl-flatten"></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doFlatten()">üìã Flatten PDF</button></div>
    ${progHTML('flatten')}${resHTML('flatten')}`;
};
async function doFlatten(){
  const files=STATE.flatten?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('flatten',40,'Flattening‚Ä¶');
  const doc=await loadPDF(files[0]);
  try{doc.getForm().flatten();}catch(e){}
  const b=await doc.save();showProg('flatten',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'flattened.pdf');
  showRes('flatten','PDF flattened successfully');
}

// METADATA
RENDERERS.metadata=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('metadata')}
    <div class="files-list" id="fl-metadata"></div>
    <div class="btn-row"><button class="btn btn-ghost" onclick="loadMeta()">üìñ Load Current Metadata</button></div>
    <div class="ctrl-card" style="margin-top:14px">
      <h4>üè∑Ô∏è Document Properties</h4>
      <div class="ctrl-row"><label>Title</label><input class="inp" id="mt-tit" placeholder="Document title" style="flex:1"></div>
      <div class="ctrl-row"><label>Author</label><input class="inp" id="mt-aut" placeholder="Author name" style="flex:1"></div>
      <div class="ctrl-row"><label>Subject</label><input class="inp" id="mt-sub" placeholder="Subject" style="flex:1"></div>
      <div class="ctrl-row"><label>Keywords</label><input class="inp" id="mt-kw" placeholder="keyword1, keyword2" style="flex:1"></div>
      <div class="ctrl-row"><label>Creator</label><input class="inp" id="mt-cre" placeholder="e.g. Word, InDesign" style="flex:1"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doMeta()">üè∑Ô∏è Save Metadata</button></div>
    ${progHTML('metadata')}${resHTML('metadata')}`;
};
async function loadMeta(){
  const files=STATE.metadata?.files||[];if(!files.length){alert('Select a PDF first.');return;}
  const doc=await loadPDF(files[0]);
  document.getElementById('mt-tit').value=doc.getTitle()||'';
  document.getElementById('mt-aut').value=doc.getAuthor()||'';
  document.getElementById('mt-sub').value=doc.getSubject()||'';
  document.getElementById('mt-kw').value=doc.getKeywords()||'';
  document.getElementById('mt-cre').value=doc.getCreator()||'';
}
async function doMeta(){
  const files=STATE.metadata?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('metadata',40,'Updating‚Ä¶');
  const doc=await loadPDF(files[0]);
  const v=id=>document.getElementById(id).value;
  if(v('mt-tit'))doc.setTitle(v('mt-tit'));if(v('mt-aut'))doc.setAuthor(v('mt-aut'));
  if(v('mt-sub'))doc.setSubject(v('mt-sub'));if(v('mt-kw'))doc.setKeywords([v('mt-kw')]);
  if(v('mt-cre'))doc.setCreator(v('mt-cre'));doc.setModificationDate(new Date());
  const b=await doc.save();showProg('metadata',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'metadata_updated.pdf');
  showRes('metadata','Metadata updated and saved');
}

// EXTRACT TEXT BY PAGE
RENDERERS.extracttext=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('extracttext')}
    <div class="files-list" id="fl-extracttext"></div>
    <div class="ctrl-card"><h4>üìÑ Page Selection</h4>
      <div class="ctrl-row"><label>Pages</label><input class="inp" id="et-pgs" placeholder="all  or  1,3,5-8" style="flex:1"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doExtractText()">üìÑ Extract Text</button></div>
    ${progHTML('extracttext')}
    <div id="et-out" style="display:none;margin-top:14px">
      <textarea id="et-area" class="code-area" style="height:300px" readonly></textarea>
      <div class="btn-row" style="margin-top:10px">
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('et-area').select()">üìã Select All</button>
        <button class="btn btn-success btn-sm" onclick="saveAs(new Blob([document.getElementById('et-area').value],{type:'text/plain'}),'extracted.txt')">üíæ Save .txt</button>
      </div>
    </div>`;
};
async function doExtractText(){
  const files=STATE.extracttext?.files||[];if(!files.length){alert('Select a PDF.');return;}
  const raw=document.getElementById('et-pgs').value.trim();
  showProg('extracttext',10,'Loading‚Ä¶');
  const bytes=await files[0].arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:bytes}).promise;
  let pgNums=[];
  if(!raw)for(let i=1;i<=pdf.numPages;i++)pgNums.push(i);
  else raw.split(',').forEach(s=>{s=s.trim();if(s.includes('-')){const[a,b]=s.split('-');for(let i=+a;i<=+b;i++)pgNums.push(i);}else pgNums.push(+s);});
  let all='';
  for(let i=0;i<pgNums.length;i++){
    showProg('extracttext',10+Math.round((i/pgNums.length)*87),`Reading page ${pgNums[i]}‚Ä¶`);
    const pg=await pdf.getPage(pgNums[i]);const tc=await pg.getTextContent();
    all+=`\n--- Page ${pgNums[i]} ---\n`+tc.items.map(it=>it.str).join(' ')+'\n';
  }
  showProg('extracttext',100,'Done!');
  document.getElementById('et-out').style.display='';
  document.getElementById('et-area').value=all.trim();
}

// PROTECT
RENDERERS.protect=()=>{
  document.getElementById('toolBody').innerHTML=`
    <div class="info-box"><strong>‚ö†Ô∏è Note:</strong> Browser-based PDF encryption is metadata-level. For AES-256 encryption, use a desktop tool like LibreOffice or Adobe.</div>
    ${dz('protect')}
    <div class="files-list" id="fl-protect"></div>
    <div class="ctrl-card"><h4>üîê Password Settings</h4>
      <div class="ctrl-row"><label>User password</label><input type="password" class="inp" id="pr-usr" placeholder="Password to open" style="flex:1"></div>
      <div class="ctrl-row"><label>Owner password</label><input type="password" class="inp" id="pr-own" placeholder="Admin password" style="flex:1"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doProtect()">üîê Protect & Save</button></div>
    ${progHTML('protect')}${resHTML('protect')}`;
};
async function doProtect(){
  const files=STATE.protect?.files||[];if(!files.length){alert('Select a PDF.');return;}
  if(!document.getElementById('pr-usr').value){alert('Enter a password.');return;}
  showProg('protect',50,'Processing‚Ä¶');
  const doc=await loadPDF(files[0]);
  doc.setCreator('PDF Toolkit Pro');
  const b=await doc.save();showProg('protect',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'protected.pdf');
  showRes('protect','File saved. Note: use a desktop app for strong AES-256 encryption.');
}

// UNLOCK
RENDERERS.unlock=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('unlock')}
    <div class="files-list" id="fl-unlock"></div>
    <div class="ctrl-card"><h4>üîì Password</h4>
      <div class="ctrl-row"><label>PDF Password</label><input type="password" class="inp" id="ul-pw" placeholder="Enter PDF password" style="flex:1"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doUnlock()">üîì Unlock PDF</button></div>
    ${progHTML('unlock')}${resHTML('unlock')}`;
};
async function doUnlock(){
  const files=STATE.unlock?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('unlock',40,'Unlocking‚Ä¶');
  try{
    const doc=await PDFDocument.load(await files[0].arrayBuffer(),{password:document.getElementById('ul-pw').value,ignoreEncryption:true});
    const b=await doc.save();showProg('unlock',100,'Done!');
    saveAs(new Blob([b],{type:'application/pdf'}),'unlocked.pdf');
    showRes('unlock','PDF unlocked and saved successfully');
  }catch(e){showProg('unlock',100,'');showRes('unlock','Could not unlock ‚Äî wrong password or unsupported encryption method.');}
}

// COMPRESS
RENDERERS.compress=()=>{
  document.getElementById('toolBody').innerHTML=`
    <div class="info-box"><strong>‚ÑπÔ∏è</strong> Removes redundant objects and optimizes structure. For heavy image compression, a server-side tool is more effective.</div>
    ${dz('compress')}
    <div class="files-list" id="fl-compress"></div>
    <div class="ctrl-card"><h4>üóúÔ∏è Compression Level</h4>
      <div class="ctrl-row"><label>Level</label>
        <select class="inp" id="co-lv">
          <option value="low">Low ‚Äî Best Quality</option>
          <option value="med" selected>Medium ‚Äî Balanced</option>
          <option value="high">High ‚Äî Smallest Size</option>
        </select>
      </div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doCompress()">üóúÔ∏è Compress</button></div>
    ${progHTML('compress')}${resHTML('compress')}`;
};
async function doCompress(){
  const files=STATE.compress?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('compress',30,'Loading‚Ä¶');
  const doc=await PDFDocument.load(await files[0].arrayBuffer());
  showProg('compress',70,'Optimizing‚Ä¶');
  const b=await doc.save({useObjectStreams:true,addDefaultPage:false,objectsPerTick:50});
  showProg('compress',100,'Done!');
  const saved=files[0].size-b.length;
  saveAs(new Blob([b],{type:'application/pdf'}),'compressed.pdf');
  showRes('compress',`${fmtSz(files[0].size)} ‚Üí ${fmtSz(b.length)} ${saved>0?'(saved '+fmtSz(saved)+')':'(already optimized)'}`);
}

// GRAYSCALE
RENDERERS.grayscale=()=>{
  document.getElementById('toolBody').innerHTML=`
    <div class="info-box"><strong>‚ÑπÔ∏è</strong> Each page is rendered and re-encoded as a grayscale image. Output is a rasterized PDF.</div>
    ${dz('grayscale')}
    <div class="files-list" id="fl-grayscale"></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doGrayscale()">‚¨õ Convert to Grayscale</button></div>
    ${progHTML('grayscale')}${resHTML('grayscale')}`;
};
async function doGrayscale(){
  const files=STATE.grayscale?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('grayscale',10,'Loading‚Ä¶');
  const pdf=await pdfjsLib.getDocument({data:await files[0].arrayBuffer()}).promise;
  const nd=await PDFDocument.create();
  for(let i=1;i<=pdf.numPages;i++){
    showProg('grayscale',10+Math.round((i/pdf.numPages)*83),`Converting page ${i}/${pdf.numPages}‚Ä¶`);
    const pg=await pdf.getPage(i);const vp=pg.getViewport({scale:2});
    const c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;
    const ctx=c.getContext('2d');await pg.render({canvasContext:ctx,viewport:vp}).promise;
    const id=ctx.getImageData(0,0,c.width,c.height);
    for(let j=0;j<id.data.length;j+=4){const g=id.data[j]*.3+id.data[j+1]*.59+id.data[j+2]*.11;id.data[j]=id.data[j+1]=id.data[j+2]=g;}
    ctx.putImageData(id,0,0);
    const b64=c.toDataURL('image/jpeg',.9).split(',')[1];
    const jb=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
    const img=await nd.embedJpg(jb);
    const p=nd.addPage([vp.width/2,vp.height/2]);
    p.drawImage(img,{x:0,y:0,width:vp.width/2,height:vp.height/2});
  }
  const b=await nd.save();showProg('grayscale',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'grayscale.pdf');
  showRes('grayscale',`Converted ${pdf.numPages} pages to grayscale`);
}

// PDF ‚Üí IMAGES
RENDERERS.pdf2img=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('pdf2img')}
    <div class="files-list" id="fl-pdf2img"></div>
    <div class="ctrl-card"><h4>üñºÔ∏è Export Settings</h4>
      <div class="ctrl-row"><label>Format</label>
        <select class="inp" id="pi-fmt"><option value="image/jpeg">JPG</option><option value="image/png">PNG</option></select>
      </div>
      <div class="ctrl-row"><label>Resolution</label>
        <select class="inp" id="pi-sc">
          <option value="1">72 DPI (web)</option>
          <option value="2" selected>144 DPI (standard)</option>
          <option value="3">216 DPI (print)</option>
          <option value="4">288 DPI (high quality)</option>
        </select>
      </div>
      <div class="ctrl-row"><label>Pages</label><input class="inp" id="pi-pgs" placeholder="all  or  1,3,5-8" style="flex:1"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doPDF2Img()">üñºÔ∏è Export Images</button></div>
    ${progHTML('pdf2img')}${resHTML('pdf2img')}`;
};
async function doPDF2Img(){
  const files=STATE.pdf2img?.files||[];if(!files.length){alert('Select a PDF.');return;}
  const fmt=document.getElementById('pi-fmt').value;
  const sc=parseFloat(document.getElementById('pi-sc').value);
  const raw=document.getElementById('pi-pgs').value.trim();
  showProg('pdf2img',10,'Loading‚Ä¶');
  const pdf=await pdfjsLib.getDocument({data:await files[0].arrayBuffer()}).promise;
  let pgNums=[];
  if(!raw)for(let i=1;i<=pdf.numPages;i++)pgNums.push(i);
  else raw.split(',').forEach(s=>{s=s.trim();if(s.includes('-')){const[a,b]=s.split('-');for(let i=+a;i<=+b;i++)pgNums.push(i);}else pgNums.push(+s);});
  const ext=fmt.includes('png')?'png':'jpg';
  for(let i=0;i<pgNums.length;i++){
    showProg('pdf2img',10+Math.round((i/pgNums.length)*87),`Exporting page ${pgNums[i]}‚Ä¶`);
    const pg=await pdf.getPage(pgNums[i]);const vp=pg.getViewport({scale:sc});
    const c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;
    await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
    await new Promise(res=>c.toBlob(blob=>{saveAs(blob,`page_${pgNums[i]}.${ext}`);res();},fmt,.92));
  }
  showProg('pdf2img',100,'Done!');showRes('pdf2img',`Exported ${pgNums.length} image(s)`);
}

// IMAGES ‚Üí PDF
RENDERERS.img2pdf=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('img2pdf',true,'.jpg,.jpeg,.png,.webp,image/*','Drop images here (JPG, PNG, WebP‚Ä¶)')}
    <div class="files-list" id="fl-img2pdf"></div>
    <div class="ctrl-card"><h4>üì∑ PDF Settings</h4>
      <div class="ctrl-row"><label>Page size</label>
        <select class="inp" id="ip-sz"><option value="a4">A4</option><option value="letter">Letter</option><option value="fit">Fit to image</option></select>
      </div>
      <div class="ctrl-row"><label>Orientation</label>
        <select class="inp" id="ip-or"><option value="portrait">Portrait</option><option value="landscape">Landscape</option></select>
      </div>
      <div class="ctrl-row"><label>Margin (pt)</label><input type="number" class="inp" id="ip-mg" value="20" min="0" max="100" style="width:80px"></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doImg2PDF()">üì∑ Create PDF</button></div>
    ${progHTML('img2pdf')}${resHTML('img2pdf')}`;
};
async function doImg2PDF(){
  const files=STATE.img2pdf?.files||[];if(!files.length){alert('Select images.');return;}
  const szMap={a4:[595,842],letter:[612,792]};
  const szMode=document.getElementById('ip-sz').value;
  const mg=parseInt(document.getElementById('ip-mg').value)||0;
  const landscape=document.getElementById('ip-or').value==='landscape';
  showProg('img2pdf',10,'Creating‚Ä¶');
  const doc=await PDFDocument.create();
  for(let i=0;i<files.length;i++){
    showProg('img2pdf',10+Math.round((i/files.length)*85),`Adding image ${i+1}/${files.length}‚Ä¶`);
    const ab=await files[i].arrayBuffer();const bytes=new Uint8Array(ab);
    let img;
    try{img=files[i].type==='image/png'||files[i].name.endsWith('.png')?await doc.embedPng(bytes):await doc.embedJpg(bytes);}
    catch(e){try{img=await doc.embedJpg(bytes);}catch(e2){continue;}}
    const{width:iw,height:ih}=img;
    let[pw,ph]=szMode==='fit'?[iw+mg*2,ih+mg*2]:szMap[szMode];
    if(landscape&&szMode!=='fit')[pw,ph]=[ph,pw];
    const pg=doc.addPage([pw,ph]);
    const sc=Math.min((pw-mg*2)/iw,(ph-mg*2)/ih,1);
    pg.drawImage(img,{x:(pw-iw*sc)/2,y:(ph-ih*sc)/2,width:iw*sc,height:ih*sc});
  }
  const b=await doc.save();showProg('img2pdf',100,'Done!');
  saveAs(new Blob([b],{type:'application/pdf'}),'images.pdf');
  showRes('img2pdf',`Created PDF with ${files.length} image(s) ¬∑ ${fmtSz(b.length)}`);
}

// PDF ‚Üí TEXT
RENDERERS.pdf2text=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('pdf2text')}
    <div class="files-list" id="fl-pdf2text"></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doPDF2Text()">üìù Extract All Text</button></div>
    ${progHTML('pdf2text')}
    <div id="pt-out" style="display:none;margin-top:14px">
      <textarea id="pt-area" class="code-area" style="height:340px" readonly></textarea>
      <div class="btn-row" style="margin-top:10px">
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('pt-area').select()">üìã Select All</button>
        <button class="btn btn-success btn-sm" onclick="saveAs(new Blob([document.getElementById('pt-area').value],{type:'text/plain'}),'text.txt')">üíæ Save .txt</button>
      </div>
    </div>`;
};
async function doPDF2Text(){
  const files=STATE.pdf2text?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('pdf2text',10,'Loading‚Ä¶');
  const pdf=await pdfjsLib.getDocument({data:await files[0].arrayBuffer()}).promise;
  let all='';
  for(let i=1;i<=pdf.numPages;i++){
    showProg('pdf2text',10+Math.round((i/pdf.numPages)*87),`Reading page ${i}/${pdf.numPages}‚Ä¶`);
    const pg=await pdf.getPage(i);const tc=await pg.getTextContent();
    all+=`\n--- Page ${i} ---\n`+tc.items.map(it=>it.str).join(' ')+'\n';
  }
  showProg('pdf2text',100,'Done!');
  document.getElementById('pt-out').style.display='';
  document.getElementById('pt-area').value=all.trim();
}

// EXTRACT IMAGES
RENDERERS.extractimages=()=>{
  document.getElementById('toolBody').innerHTML=`
    <div class="info-box"><strong>‚ÑπÔ∏è</strong> Renders each PDF page as a high-quality image and saves it.</div>
    ${dz('extractimages')}
    <div class="files-list" id="fl-extractimages"></div>
    <div class="ctrl-card"><h4>üé® Export Settings</h4>
      <div class="ctrl-row"><label>Scale / DPI</label>
        <select class="inp" id="ei-sc"><option value="1">1√ó (72 DPI)</option><option value="2" selected>2√ó (144 DPI)</option><option value="3">3√ó (216 DPI)</option></select>
      </div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doExtractImages()">üé® Extract & Save</button></div>
    ${progHTML('extractimages')}${resHTML('extractimages')}`;
};
async function doExtractImages(){
  const files=STATE.extractimages?.files||[];if(!files.length){alert('Select a PDF.');return;}
  const sc=parseFloat(document.getElementById('ei-sc').value);
  showProg('extractimages',10,'Loading‚Ä¶');
  const pdf=await pdfjsLib.getDocument({data:await files[0].arrayBuffer()}).promise;
  for(let i=1;i<=pdf.numPages;i++){
    showProg('extractimages',10+Math.round((i/pdf.numPages)*87),`Exporting page ${i}/${pdf.numPages}‚Ä¶`);
    const pg=await pdf.getPage(i);const vp=pg.getViewport({scale:sc});
    const c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;
    await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
    await new Promise(res=>c.toBlob(blob=>{saveAs(blob,`page_${i}.jpg`);res();},'image/jpeg',.92));
  }
  showProg('extractimages',100,'Done!');showRes('extractimages',`Saved ${pdf.numPages} image(s)`);
}

// HTML ‚Üí PDF
RENDERERS.html2pdf=()=>{
  document.getElementById('toolBody').innerHTML=`
    <div class="info-box"><strong>‚ÑπÔ∏è</strong> After clicking convert, a print dialog will open. Choose <strong>Save as PDF</strong> as the destination.</div>
    <div class="ctrl-card"><h4>üåê HTML Content</h4>
      <div class="ctrl-row"><label>Document title</label><input class="inp" id="h2p-tit" value="My Document" style="flex:1"></div>
      <textarea id="h2p-html" class="code-area" style="height:220px;margin-top:12px" placeholder="Paste your HTML here‚Ä¶"><h1>Hello World</h1><p>This is a sample document.</p></textarea>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doH2P()">üåê Convert ‚Üí Open Print Dialog</button></div>`;
};
function doH2P(){
  const html=document.getElementById('h2p-html').value;
  const title=document.getElementById('h2p-tit').value||'Document';
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>${title}</title><style>body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto;color:#222}h1,h2,h3{color:#111}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ddd;padding:8px}</style></head><body>${html}</body></html>`);
  w.document.close();setTimeout(()=>w.print(),600);
}

// VIEWER
RENDERERS.viewer=()=>{
  document.getElementById('toolBody').innerHTML=`
    ${dz('viewer',false,'.pdf','Drop PDF here to view')}
    <div class="files-list" id="fl-viewer"></div>
    <div class="viewer-nav" id="vn" style="display:none">
      <button class="btn btn-ghost btn-sm" onclick="viewerNav(-1)">‚óÄ Prev</button>
      <span class="pg-counter" id="vpc">Page ‚Äî of ‚Äî</span>
      <button class="btn btn-ghost btn-sm" onclick="viewerNav(1)">Next ‚ñ∂</button>
      <select class="inp" id="vz" onchange="viewerRender()" style="width:auto">
        <option value=".75">75%</option><option value="1">100%</option>
        <option value="1.5">150%</option><option value="2" selected>200%</option>
        <option value="3">300%</option>
      </select>
    </div>
    <div id="viewer-canvas-wrap"><canvas id="viewer-canvas"></canvas></div>`;
};
let VWR={pdf:null,page:1};
document.addEventListener('change',async e=>{
  if(e.target.id==='fi-viewer'){
    const f=e.target.files[0];if(!f)return;
    STATE.viewer={files:[f]};renderFL('viewer',[f]);
    VWR.pdf=await pdfjsLib.getDocument({data:await f.arrayBuffer()}).promise;
    VWR.page=1;document.getElementById('vn').style.display='flex';viewerRender();
  }
});
async function viewerRender(){
  if(!VWR.pdf)return;
  const sc=parseFloat(document.getElementById('vz').value)||2;
  const pg=await VWR.pdf.getPage(VWR.page);const vp=pg.getViewport({scale:sc});
  const c=document.getElementById('viewer-canvas');c.width=vp.width;c.height=vp.height;
  await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  document.getElementById('vpc').textContent=`Page ${VWR.page} of ${VWR.pdf.numPages}`;
}
function viewerNav(d){if(!VWR.pdf)return;VWR.page=Math.max(1,Math.min(VWR.pdf.numPages,VWR.page+d));viewerRender();}

// COMPARE
RENDERERS.compare=()=>{
  document.getElementById('toolBody').innerHTML=`
    <div class="compare-grid">
      <div><div class="compare-pane"><h4>üìÑ PDF 1 (Original)</h4>${dz('compare1',false,'.pdf','First PDF')}<div class="files-list" id="fl-compare1"></div></div></div>
      <div><div class="compare-pane"><h4>üìÑ PDF 2 (Modified)</h4>${dz('compare2',false,'.pdf','Second PDF')}<div class="files-list" id="fl-compare2"></div></div></div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doCompare()">üîç Compare PDFs</button></div>
    ${progHTML('compare')}
    <div id="cmp-result" style="display:none;margin-top:16px"></div>`;
};
async function doCompare(){
  const f1=(STATE.compare1?.files||[])[0];const f2=(STATE.compare2?.files||[])[0];
  if(!f1||!f2){alert('Select both PDFs.');return;}
  async function getText(f){
    const pdf=await pdfjsLib.getDocument({data:await f.arrayBuffer()}).promise;let t='';
    for(let i=1;i<=pdf.numPages;i++){const pg=await pdf.getPage(i);const tc=await pg.getTextContent();t+=tc.items.map(it=>it.str).join(' ')+'\\n';}
    return t;
  }
  showProg('compare',20,'Reading PDF 1‚Ä¶');const t1=await getText(f1);
  showProg('compare',55,'Reading PDF 2‚Ä¶');const t2=await getText(f2);
  showProg('compare',80,'Comparing‚Ä¶');
  const w1=new Set(t1.toLowerCase().split(/\s+/).filter(w=>w.length>2));
  const w2=new Set(t2.toLowerCase().split(/\s+/).filter(w=>w.length>2));
  const only1=[...w1].filter(w=>!w2.has(w)&&w.length>3).slice(0,40);
  const only2=[...w2].filter(w=>!w1.has(w)&&w.length>3).slice(0,40);
  const common=[...w1].filter(w=>w2.has(w)).length;
  const sim=Math.round((common/Math.max(w1.size,w2.size))*100);
  showProg('compare',100,'Done!');
  const simColor=sim>80?'#10b981':sim>50?'#f59e0b':'#ef4444';
  document.getElementById('cmp-result').style.display='';
  document.getElementById('cmp-result').innerHTML=`
    <div class="ctrl-card">
      <h4>üìä Comparison Results</h4>
      <div style="text-align:center;margin:12px 0 20px">
        <div style="font-size:3rem;font-weight:900;color:${simColor}">${sim}%</div>
        <div style="color:var(--txt2);font-size:.85rem">similarity score</div>
        <div class="sim-meter"><div class="sim-fill" style="width:${sim}%;background:${simColor}"></div></div>
      </div>
      <div class="ctrl-row"><label>Words in PDF 1</label><span style="font-weight:700">${w1.size.toLocaleString()}</span></div>
      <div class="ctrl-row"><label>Words in PDF 2</label><span style="font-weight:700">${w2.size.toLocaleString()}</span></div>
      <div class="ctrl-row"><label>Common words</label><span style="font-weight:700;color:var(--ok)">${common.toLocaleString()}</span></div>
      ${only1.length?`<div style="margin-top:14px"><div style="font-size:.78rem;color:var(--txt3);margin-bottom:6px;text-transform:uppercase;letter-spacing:.08em">Only in PDF 1</div>${only1.map(w=>`<span style="display:inline-block;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:#ef4444;font-size:.7rem;padding:2px 8px;border-radius:6px;margin:2px">${w}</span>`).join('')}</div>`:''}
      ${only2.length?`<div style="margin-top:10px"><div style="font-size:.78rem;color:var(--txt3);margin-bottom:6px;text-transform:uppercase;letter-spacing:.08em">Only in PDF 2</div>${only2.map(w=>`<span style="display:inline-block;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:#10b981;font-size:.7rem;padding:2px 8px;border-radius:6px;margin:2px">${w}</span>`).join('')}</div>`:''}
    </div>`;
}

// REPAIR
RENDERERS.repair=()=>{
  document.getElementById('toolBody').innerHTML=`
    <div class="info-box"><strong>‚ÑπÔ∏è</strong> Attempts to reload and re-save the PDF, fixing minor structural corruption. Severely damaged files may not be recoverable.</div>
    ${dz('repair')}
    <div class="files-list" id="fl-repair"></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doRepair()">üîß Attempt Repair</button></div>
    ${progHTML('repair')}${resHTML('repair')}`;
};
async function doRepair(){
  const files=STATE.repair?.files||[];if(!files.length){alert('Select a PDF.');return;}
  showProg('repair',40,'Attempting repair‚Ä¶');
  try{
    const doc=await PDFDocument.load(await files[0].arrayBuffer(),{ignoreEncryption:true,throwOnInvalidObject:false});
    const b=await doc.save();showProg('repair',100,'Done!');
    saveAs(new Blob([b],{type:'application/pdf'}),'repaired.pdf');
    showRes('repair',`Repair attempt complete ¬∑ ${fmtSz(b.length)}`);
  }catch(e){showProg('repair',100,'');showRes('repair',`Could not repair: ${e.message}`);}
}

// BLANK PDF
RENDERERS.blank=()=>{
  document.getElementById('toolBody').innerHTML=`
    <div class="ctrl-card"><h4>‚ûï Blank PDF Settings</h4>
      <div class="ctrl-row"><label>Page size</label>
        <select class="inp" id="bl-sz" onchange="toggleBlankCustom()">
          <option value="a4">A4 (210√ó297mm)</option><option value="letter">Letter (8.5√ó11in)</option>
          <option value="a3">A3 (297√ó420mm)</option><option value="a5">A5 (148√ó210mm)</option>
          <option value="custom">Custom size</option>
        </select>
      </div>
      <div id="bl-cust" style="display:none">
        <div class="ctrl-row"><label>Width (pt)</label><input type="number" class="inp" id="bl-w" value="595" min="100" style="width:100px"></div>
        <div class="ctrl-row"><label>Height (pt)</label><input type="number" class="inp" id="bl-h" value="842" min="100" style="width:100px"></div>
      </div>
      <div class="ctrl-row"><label>Orientation</label>
        <select class="inp" id="bl-or"><option value="portrait">Portrait</option><option value="landscape">Landscape</option></select>
      </div>
      <div class="ctrl-row"><label>Number of pages</label><input type="number" class="inp" id="bl-pgs" value="1" min="1" max="200" style="width:80px"></div>
      <div class="ctrl-row"><label>Background</label>
        <select class="inp" id="bl-bg">
          <option value="white">White</option><option value="cream">Cream / Off-white</option>
          <option value="gray">Light Gray</option><option value="black">Black (dark mode)</option>
        </select>
      </div>
    </div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doBlank()">‚ûï Generate PDF</button></div>
    ${resHTML('blank')}`;
};
function toggleBlankCustom(){document.getElementById('bl-cust').style.display=document.getElementById('bl-sz').value==='custom'?'':'none';}
async function doBlank(){
  const szMap={a4:[595,842],letter:[612,792],a3:[842,1191],a5:[420,595]};
  const m=document.getElementById('bl-sz').value;
  let[w,h]=m==='custom'?[+document.getElementById('bl-w').value,+document.getElementById('bl-h').value]:szMap[m];
  if(document.getElementById('bl-or').value==='landscape')[w,h]=[h,w];
  const n=parseInt(document.getElementById('bl-pgs').value)||1;
  const bgMap={white:rgb(1,1,1),cream:rgb(.99,.97,.91),gray:rgb(.94,.94,.94),black:rgb(.08,.08,.08)};
  const bg=bgMap[document.getElementById('bl-bg').value];
  const doc=await PDFDocument.create();
  for(let i=0;i<n;i++){const p=doc.addPage([w,h]);p.drawRectangle({x:0,y:0,width:w,height:h,color:bg});}
  const b=await doc.save();
  saveAs(new Blob([b],{type:'application/pdf'}),`blank_${n}pg.pdf`);
  showRes('blank',`Created ${n}-page PDF ¬∑ ${w}√ó${h}pt ¬∑ ${fmtSz(b.length)}`);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
renderHome();
</script>
</body>
</html>
